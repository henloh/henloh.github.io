/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/base/util/isPlainObject","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Core","sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/write/_internal/condenser/classifications/LastOneWins","sap/ui/fl/write/_internal/condenser/classifications/Reverse","sap/ui/fl/write/_internal/condenser/UIReconstruction","sap/ui/fl/write/_internal/condenser/Utils","sap/ui/fl/Change","sap/ui/fl/Utils","sap/ui/performance/Measurement"],function(e,n,t,r,i,a,o,s,f,c,u,d,l,p){"use strict";var h={};var g="unclassified";var C={lastOneWins:s,reverse:f};var v=["affectedControl","sourceContainer","targetContainer"];function y(e,n){var t=e[a.Move];return n.classification===a.Create&&t&&t[t.length-1].targetContainer===n.targetContainer}function E(e,n){return n.classification===a.Move&&e[a.Destroy]}function I(e,n){return n.classification===a.Create&&e[a.Destroy]}function S(e,n,t,r){if(!E(e,t)&&!I(e,t)){var i=t.classification;if(!e[i]){t.change=r;r.condenserState="select";e[i]=[t]}else{r.condenserState="delete"}e[i][0].updateChange=r}if(y(e,t)||I(e,t)){if(e[a.Move]){e[a.Move].forEach(function(e){e.change.condenserState="delete"});delete e[a.Move]}if(e[a.Destroy]){e[a.Destroy].forEach(function(e){e.change.condenserState="delete"});delete e[a.Destroy]}}return c.addChange(n,t)}function m(e,n,t,r,i){if(!e[r.type]){e[r.type]={}}var a=e[r.type];if(r.type===u.NOT_INDEX_RELEVANT){if(!a[r.classification]){a[r.classification]={}}var o=a[r.classification];C[r.classification].addToChangesMap(o,r.uniqueKey,i);return Promise.resolve()}t.push(i);return S(a,n,r,i)}function _(e,n,t){if(!e[n]){e[n]=[]}e[n].push(t);t.condenserState="select"}function M(e,n){var t=r.getControlIdBySelector(n.getSelector(),e);var a=i.byId(t);if(a){var s={modifier:r,appComponent:e,view:l.getViewForControl(a)};var f=o.getControlIfTemplateAffected(n,a,s);return Promise.resolve(o.getChangeHandler(n,f,s)).then(function(e){if(e&&typeof e.getCondenserInfo==="function"){return e.getCondenserInfo(n,s)}return undefined}).then(function(e){if(e&&f.bTemplateAffected){x(e,n)}return e}).catch(function(){return undefined})}return Promise.resolve()}function x(e,n){var t=n.getOriginalSelector();var r=n.getSelector();v.forEach(function(n){if(e[n]&&e[n]===r){e[n]=t}})}function A(e,n,t,i){var a=n!==undefined?n.affectedControl:r.getControlIdBySelector(t.getSelector(),i);if(!e[a]){e[a]={}}return e[a]}function O(e,n,t,r,i){return i.reduce(function(i,a){return i.then(N.bind(this,e,n,t,r,a))}.bind(this),Promise.resolve())}function N(e,n,t,r,i){return M(e,i).then(function(a){D(a,e);var o=A(n,a,i,e);if(a!==undefined){T(a);return m(o,t,r,a,i)}_(o,g,i);n[g]=true;return undefined})}function T(e){if(C[e.classification]){e.type=u.NOT_INDEX_RELEVANT}else{e.type=u.INDEX_RELEVANT}}function D(e,n){v.forEach(function(t){if(e&&e[t]){e[t]=r.getControlIdBySelector(e[t],n)}})}function R(t,r){e(t,function(e,i){if(C[e]&&C[e].getChangesFromMap){C[e].getChangesFromMap(t,e).forEach(function(e){r.push(e)})}else if(n(i)){return R(i,r)}else if(Array.isArray(i)){i.forEach(function(e){if(e instanceof d){r.push(e)}else{r.push(e.change)}})}});return r}function b(e){return R(e,[])}function w(t,r){e(t,function(e,t){if(n(t)){w(t,r)}else if(Array.isArray(t)){t.forEach(function(e){if(!(e instanceof d)){r.push(e)}})}});return r}function L(e,n){n.sort(function(n,t){return e.indexOf(n)-e.indexOf(t)})}function P(e,n){n.sort(function(n,t){return e.indexOf(n.change)-e.indexOf(t.change)})}function U(e,n){var t=e.map(function(e){return e.getId()});n.forEach(function(n){if(t.indexOf(n.getId())===-1){e.push(n)}})}function V(e,n){e.forEach(function(e){var t=e.updateChange;if(t&&t.getState()!==d.states.NEW){var r=e.change;if(t.getId()!==r.getId()){var i=r.getContent();t.setContent(i);r.condenserState="delete";n=n.map(function(e){if(e.getId()===r.getId()){return t}return e})}else{t.setState(d.states.DIRTY)}t.condenserState="update"}});return n}h.condense=function(e,n){p.start("Condenser_overall","Condenser overall - CondenserClass",["sap.ui.fl","Condenser"]);var r={};var i={};var a=[];var o=[];var s=[];n.slice(0).reverse().forEach(function(e){if(e instanceof d&&e.isSuccessfullyApplied()){s.push(e)}else{o.push(e)}});p.start("Condenser_defineMaps","defining of maps - CondenserClass",["sap.ui.fl","Condenser"]);return O(e,r,i,a,s).then(function(){p.end("Condenser_defineMaps");var e=r[g];if(!e){c.compareAndUpdate(r,i)}var s=b(r);if(e){a.forEach(function(e){e.condenserState="select"});U(s,a)}s=s.concat(o);L(n,s);if(!e){p.start("Condenser_handleIndexRelatedChanges","handle index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var f=true;var u=w(r,[]);P(n,u);var d;try{p.start("Condenser_sort","sort index related changes - CondenserClass",["sap.ui.fl","Condenser"]);d=c.sortIndexRelatedChanges(i,u)}catch(e){t.error("Error during Condensing: "+e.message,"No Condensing performed for index-relevant changes.");f=false}p.end("Condenser_sort");if(f){c.swapChanges(d,s);s=V(u,s)}else{a.forEach(function(e){e.condenserState="select"});U(s,a);L(n,s)}p.end("Condenser_handleIndexRelatedChanges")}p.end("Condenser_overall");return s})};return h});
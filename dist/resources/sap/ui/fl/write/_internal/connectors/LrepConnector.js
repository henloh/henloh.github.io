/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/merge","sap/ui/fl/write/connectors/BaseConnector","sap/ui/fl/initial/_internal/connectors/LrepConnector","sap/ui/fl/initial/_internal/connectors/Utils","sap/ui/fl/write/_internal/connectors/Utils","sap/ui/fl/write/_internal/transport/TransportSelection","sap/ui/fl/registry/Settings","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/fl/Change","sap/ui/core/Component","sap/ui/core/BusyIndicator","sap/base/Log","sap/m/MessageBox","sap/base/util/restricted/_pick"],function(e,t,r,n,a,s,i,o,u,l,c,f,p,d,g,v){"use strict";var T={FLEX_INFO:"/flex/info/",PUBLISH:"/actions/make_changes_transportable/",CHANGES:"/changes/",CONDENSE:"/actions/condense/",VARIANTS:"/variants/",SETTINGS:"/flex/settings",TOKEN:"/actions/getcsrftoken/",APPVARIANTS:"/appdescr_variants/",APPVARIANTS_OVERVIEW:"/app_variant_overview/",UI2PERSONALIZATION:"/ui2personalization/",CONTEXTS:"/flex/contexts/",VERSIONS:{GET:"/flex/versions/",ACTIVATE:"/flex/versions/activate/",DISCARD:"/flex/versions/draft/",PUBLISH:"/flex/versions/publish/"},MANI_FIRST_SUPPORTED:"/sap/bc/ui2/app_index/ui5_app_mani_first_supported"};var R=function(e){var t;if(e.isLegacyVariant){t=T.VARIANTS}else if(e.isAppVariant){t=T.APPVARIANTS}else if(e.isContextSharing){t=T.CONTEXTS}else if(e.isCondensingEnabled){t=T.CONDENSE}else{t=T.CHANGES}var s=e.transport?{changelist:e.transport}:{};if(e.skipIam){s.skipIam=e.skipIam}if(e.parentVersion){s.parentVersion=e.parentVersion}n.addSAPLogonLanguageInfo(s);r._addClientInfo(s);if(e.flexObject&&!e.isAppVariant){e.fileName=e.flexObject.fileName}var i=n.getUrl(t,e,s);delete e.reference;delete e.fileName;var o=n.getUrl(T.TOKEN,e);var u=a.getRequestOptions(r,o,e.flexObjects||e.flexObject,"application/json; charset=utf-8","json");return a.sendRequest(i,e.method,u)};var O=function(e){var t=e.getDefinition().layer===o.VENDOR?e.getPackage():"";return new c({fileName:e.getDefinition().fileName,fileType:e.getDefinition().fileType,packageName:t,namespace:e.getNamespace()})};var S=function(e){var t;if(e.transport){t=Promise.resolve({transport:e.transport})}else if(e.isForSmartBusiness){return Promise.resolve()}else{var r=O(e.appVariant);t=(new s).openTransportSelection(r)}return t.then(function(e){if(e==="cancel"){return Promise.reject("cancel")}if(e&&e.transport!==undefined){return e.transport}return Promise.reject(new Error("Transport information could not be determined"))})};function E(e){e.version=e.versionId;delete e.versionId;return e}return e({},t,{initialConnector:r,layers:r.layers,reset:function(e){p.show(0);var t=[];var u=Promise.resolve();if(e.layer!==o.USER){t=e.changes;u=i.getInstance().then(function(r){if(!r.isProductiveSystem()){return(new s).setTransports(t,f.get(e.reference)).then(function(){t.some(function(t){if(t.getRequest()){e.changelist=t.getRequest();return true}return false})})}})}return u.then(function(){p.show(0);var t=["reference","layer","changelist","generator"];var s=v(e,t);r._addClientInfo(s);if(e.selectorIds){s.selector=e.selectorIds}if(e.changeTypes){s.changeType=e.changeTypes}delete e.reference;var i=n.getUrl(T.CHANGES,e,s);var o=n.getUrl(T.TOKEN,e);var u=a.getRequestOptions(r,o);return a.sendRequest(i,"DELETE",u).then(function(e){if(e&&e.response){e.response.forEach(function(e){e.fileName=e.name;delete e.name})}p.hide();return e}).catch(function(e){p.hide();return Promise.reject(e)})})},publish:function(e){var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");var r=function(r){p.hide();var n=t.getText("MSG_TRANSPORT_ERROR",r?[r.message||r]:undefined);var a=t.getText("HEADER_TRANSPORT_ERROR");d.error("transport error: "+r);g.show(n,{icon:g.Icon.ERROR,title:a,styleClass:e.transportDialogSettings.styleClass});return"Error"};var n=new s;return n.openTransportSelection(null,e.transportDialogSettings.rootControl,e.transportDialogSettings.styleClass).then(function(r){if(n.checkTransportInfo(r)){p.show(0);var a={reference:e.reference,layer:e.layer};return n._prepareChangesForTransport(r,e.localChanges,e.appVariantDescriptors,a).then(function(){p.hide();if(r.transport==="ATO_NOTIFICATION"){return t.getText("MSG_ATO_NOTIFICATION")}return t.getText("MSG_TRANSPORT_SUCCESS")})}return"Cancel"})["catch"](r)},getFlexInfo:function(e){var t=["layer"];var a=v(e,t);r._addClientInfo(a);var s=n.getUrl(T.FLEX_INFO,e,a);return n.sendRequest(s).then(function(e){return e.response})},getContexts:function(e){var t=["type","$skip","$filter"];var a=v(e,t);r._addClientInfo(a);var s=n.getUrl(T.CONTEXTS,e,a);return n.sendRequest(s).then(function(e){return e.response})},loadContextDescriptions:function(e){e.method="POST";e.isContextSharing=true;return R(e).then(function(e){return e.response})},isContextSharingEnabled:function(){return Promise.resolve(true)},loadFeatures:function(e){if(r.settings){return Promise.resolve(r.settings)}var t={};r._addClientInfo(t);var a=n.getUrl(T.SETTINGS,e,t);return n.sendRequest(a).then(function(e){e.response.isVariantAdaptationEnabled=!!e.response.isPublicLayerAvailable;return e.response})},write:function(e){e.method="POST";return R(e)},condense:function(e){e.method="POST";e.isCondensingEnabled=true;return R(e)},update:function(e){if(e.flexObject.fileType==="variant"){e.isLegacyVariant=true}e.method="PUT";return R(e)},remove:function(e){var t={namespace:e.flexObject.namespace,layer:e.flexObject.layer};if(e.transport){t.changelist=e.transport}if(e.parentVersion){t.parentVersion=e.parentVersion}r._addClientInfo(t);e.fileName=e.flexObject.fileName;var s=e.flexObject.fileType==="variant"?T.VARIANTS:T.CHANGES;var i=n.getUrl(s,e,t);i=decodeURIComponent(i);delete e.fileName;var o=n.getUrl(T.TOKEN,e);var u=a.getRequestOptions(r,o,undefined,"application/json; charset=utf-8","json");return a.sendRequest(i,"DELETE",u)},appVariant:{getManifirstSupport:function(e){var t=T.MANI_FIRST_SUPPORTED+"/?id="+e.appId;return n.sendRequest(t).then(function(e){return e.response})},getManifest:function(e){var t=e.appVarUrl;var n=a.getRequestOptions(r,l.getLrepUrl()+T.TOKEN,undefined,"application/json; charset=utf-8","json");return a.sendRequest(t,"GET",n)},load:function(e){var t=n.getUrl(T.APPVARIANTS,e);var s=a.getRequestOptions(r,l.getLrepUrl()+T.TOKEN,undefined,"application/json; charset=utf-8","json");return a.sendRequest(t,"GET",s)},create:function(e){e.method="POST";e.isAppVariant=true;return R(e)},assignCatalogs:function(e){var t={};t.action=e.action;delete e.action;t.assignFromAppId=e.assignFromAppId;delete e.assignFromAppId;var s=n.getUrl(T.APPVARIANTS,e,t);delete e.reference;var i=n.getUrl(T.TOKEN,e);var o=a.getRequestOptions(r,i,undefined,"application/json; charset=utf-8","json");return a.sendRequest(s,"POST",o)},unassignCatalogs:function(e){var t={};t.action=e.action;delete e.action;var s=n.getUrl(T.APPVARIANTS,e,t);delete e.reference;var i=n.getUrl(T.TOKEN,e);var o=a.getRequestOptions(r,i,undefined,"application/json; charset=utf-8","json");return a.sendRequest(s,"POST",o)},update:function(e){return S(e).then(function(t){if(t){e.transport=t}delete e.isForSmartBusiness;e.method="PUT";e.isAppVariant=true;return R(e)})},remove:function(e){return S(e).then(function(t){var s={};if(t){s.changelist=t}delete e.isForSmartBusiness;var i=n.getUrl(T.APPVARIANTS,e,s);delete e.reference;var o=n.getUrl(T.TOKEN,e);var u=a.getRequestOptions(r,o,undefined,"application/json; charset=utf-8","json");return a.sendRequest(i,"DELETE",u)})},list:function(e){var t={};t.layer=e.layer;t["sap.app/id"]=e.reference;delete e.layer;delete e.reference;var s=n.getUrl(T.APPVARIANTS_OVERVIEW,e,t);var i=a.getRequestOptions(r,undefined,undefined,"application/json; charset=utf-8","json");return a.sendRequest(s,"GET",i)}},ui2Personalization:{create:function(e){e.initialConnector=this.initialConnector;var t=l.getLrepUrl();var n=a.getRequestOptions(r,t+T.TOKEN,e.flexObjects||e.flexObject,"application/json; charset=utf-8","json");var s=t+T.UI2PERSONALIZATION;return a.sendRequest(s,"PUT",n)},remove:function(e){e.initialConnector=this.initialConnector;var t=n.getUrl(T.UI2PERSONALIZATION,{url:l.getLrepUrl()},{reference:e.reference,containerkey:e.containerKey,itemname:e.itemName});return a.sendRequest(t,"DELETE")}},versions:{load:function(e){var t=a.getRequestOptions(r,n.getUrl(T.TOKEN,e));var s={};n.addSAPLogonLanguageInfo(s);s.limit=e.limit;var i=n.getUrl(T.VERSIONS.GET,e,s);return a.sendRequest(i,"GET",t).then(function(e){return e.response.versions.map(function(e){return E(e)})})},activate:function(e){var t=a.getRequestOptions(r,n.getUrl(T.TOKEN,e),{title:e.title},"application/json; charset=utf-8","json");var s={version:e.version};n.addSAPLogonLanguageInfo(s);var i=n.getUrl(T.VERSIONS.ACTIVATE,e,s);return a.sendRequest(i,"POST",t).then(function(e){var t=e.response;return E(t)})},discardDraft:function(e){var t=a.getRequestOptions(r,n.getUrl(T.TOKEN,e));var s=n.getUrl(T.VERSIONS.DISCARD,e);return a.sendRequest(s,"DELETE",t)},publish:function(e){var t=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");var i=function(r){p.hide();var n=t.getText("MSG_TRANSPORT_ERROR",r?[r.message||r]:undefined);var a=t.getText("HEADER_TRANSPORT_ERROR");d.error("transport error"+r);g.show(n,{icon:g.Icon.ERROR,title:a,styleClass:e.styleClass});return"Error"};var o=new s;return o.openTransportSelection(null,e.rootControl,e.styleClass,false).then(function(s){if(o.checkTransportInfo(s)){p.show(0);if(!s.transport){return Promise.reject(new Error("no transport provided as attribute of mParameters"))}if(!e.reference){return Promise.reject(new Error("no reference provided as attribute of mParameters"))}if(!e.version){return Promise.reject(new Error("no version provided as attribute of mParameters"))}var i={transport:s.transport,version:e.version};var u=n.getUrl(T.VERSIONS.PUBLISH,{url:l.getLrepUrl(),reference:e.reference},i);var c=n.getUrl(T.TOKEN,{url:l.getLrepUrl()});var f=a.getRequestOptions(r,c,undefined,"application/json; charset=utf-8","json");return a.sendRequest(u,"POST",f).then(function(){p.hide();if(s.transport==="ATO_NOTIFICATION"){return t.getText("MSG_ATO_NOTIFICATION")}return t.getText("MSG_TRANSPORT_SUCCESS")})}return"Cancel"})["catch"](i)}}})});
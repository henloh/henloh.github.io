/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/strings/hash","sap/base/util/merge","sap/ui/fl/write/connectors/BaseConnector","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/apply/_internal/connectors/ObjectStorageUtils"],function(e,t,r,n,i){"use strict";function s(e){var t=[];return i.forEachObjectInStorage(e,function(e){t.push(e.changeDefinition)}).then(function(){return t})}function a(e,t){var r=true;if(e.selectorIds){if(t.selector){r=e.selectorIds.indexOf(t.selector.id)>-1}else{r=false}}if(r&&e.changeTypes){r=e.changeTypes.indexOf(t.changeType)>-1}return r}function o(e,t){if(!e.creation){var r=Date.now()+t;e.creation=new Date(r).toISOString()}return e}function c(t){return e(t.reduce(function(e,t){return e+new Date(t.creation).getTime()},""))}var u=t({},r,{storage:undefined,layers:["ALL"],loadFlexData:function(e){return s({storage:this.storage,reference:e.reference}).then(function(e){n.sortFlexObjects(e);var t=n.getGroupedFlexObjects(e);var r=n.filterAndSortResponses(t);if(r.length){r[0].cacheKey=c(e)}return r})},write:function(e){var t=e.flexObjects.map(function(e,t){var r=i.createFlexObjectKey(e);e=o(e,++t);var n=this.storage._itemsStoredAsObjects?e:JSON.stringify(e);return this.storage.setItem(r,n)}.bind(this));return Promise.all(t).then(function(){})},update:function(e){var t=e.flexObject;var r=i.createFlexObjectKey(e.flexObject);var n=this.storage._itemsStoredAsObjects?t:JSON.stringify(t);var s=this.storage.setItem(r,n);return Promise.resolve(s)},reset:function(e){return i.forEachObjectInStorage({storage:this.storage,reference:e.reference,layer:e.layer},function(t){if(a(e,t.changeDefinition)){return Promise.resolve(this.storage.removeItem(t.key)).then(function(){return{fileName:t.changeDefinition&&t.changeDefinition.fileName}})}}.bind(this)).then(function(e){return{response:e.filter(function(e){return!!e})}})},remove:function(e){var t=i.createFlexObjectKey(e.flexObject);this.storage.removeItem(t);var r=this.storage.removeItem(t);return Promise.resolve(r)},loadFeatures:function(){return Promise.resolve({isKeyUser:true,isVariantSharingEnabled:true,isProductiveSystem:false})},getFlexInfo:function(e){e.storage=this.storage;return i.getAllFlexObjects(e).then(function(e){return{isResetEnabled:e.length>0}})}});return u});
/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/isPlainObject","sap/ui/base/ManagedObject","sap/ui/core/Core","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/registry/Settings","sap/base/Log","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/apply/_internal/flexObjects/States","sap/base/util/includes"],function(e,t,i,n,o,r,s,a,p,u,c){"use strict";var f=t.extend("sap.ui.fl.Change",{constructor:function(i){t.apply(this);if(!e(i)){a.error("Constructor : sap.ui.fl.Change : oFile is not defined")}this._oDefinition=i;this._sRequest="";this._bUserDependent=i.layer===n.USER;this._vRevertData=null;this._aUndoOperations=null;this._oExtensionPointInfo=null;this.setState(f.states.NEW);this._sPreviousState=null;this._oChangeProcessedPromise=null;this.setInitialApplyState();this._oChangeProcessingPromises={}},metadata:{properties:{state:{type:"string"},applyState:{type:"int"}}}});f.states={NEW:u.NEW,PERSISTED:u.PERSISTED,DELETED:u.DELETED,DIRTY:u.DIRTY};f.applyState={INITIAL:0,APPLYING:1,APPLY_FINISHED:2,REVERTING:3,REVERT_FINISHED:4,APPLY_SUCCESSFUL:5,APPLY_FAILED:6};f.operations={APPLY:0,REVERT:1};f.prototype.setState=function(e){var t=this.getState();if(t!==e&&this._isValidState(e)){this._sPreviousState=t;this.setProperty("state",e)}return this};f.prototype.setQueuedForRevert=function(){if(this._aQueuedProcesses[this._aQueuedProcesses.length-1]!==f.operations.REVERT){this._aQueuedProcesses.unshift(f.operations.REVERT)}};f.prototype.isQueuedForRevert=function(){return this._aQueuedProcesses.indexOf(f.operations.REVERT)>-1};f.prototype.setQueuedForApply=function(){if(this._aQueuedProcesses[this._aQueuedProcesses.length-1]!==f.operations.APPLY){this._aQueuedProcesses.unshift(f.operations.APPLY)}};f.prototype.isQueuedForApply=function(){return this._aQueuedProcesses.indexOf(f.operations.APPLY)>-1};f.prototype.setInitialApplyState=function(){this._aQueuedProcesses=[];delete this._ignoreOnce;this.setApplyState(f.applyState.INITIAL);this._oChangeProcessedPromise={};this._oChangeProcessedPromise.promise=new Promise(function(e){this._oChangeProcessedPromise.resolveFunction={resolve:e}}.bind(this))};f.prototype.isInInitialState=function(){return this._aQueuedProcesses.length===0&&this.getApplyState()===f.applyState.INITIAL};f.prototype.isValidForDependencyMap=function(){return this.getSelector()&&this.getSelector().id};f.prototype.startApplying=function(){this.setApplyState(f.applyState.APPLYING)};f.prototype.markFinished=function(e,t){this._aQueuedProcesses.pop();this._resolveChangeProcessingPromiseWithError(f.operations.APPLY,e);var i=t!==false?f.applyState.APPLY_SUCCESSFUL:f.applyState.APPLY_FAILED;this.setApplyState(i)};f.prototype.markSuccessful=function(e){this.markFinished(e,true)};f.prototype.markFailed=function(e){this.markFinished(e,false)};f.prototype.startReverting=function(){this.setApplyState(f.applyState.REVERTING)};f.prototype.markRevertFinished=function(e){this._aQueuedProcesses.pop();this._resolveChangeProcessingPromiseWithError(f.operations.REVERT,e);this.setApplyState(f.applyState.REVERT_FINISHED)};f.prototype.hasApplyProcessStarted=function(){return this.getApplyState()===f.applyState.APPLYING};f.prototype.isSuccessfullyApplied=function(){return this.getApplyState()===f.applyState.APPLY_SUCCESSFUL};f.prototype.hasApplyProcessFailed=function(){return this.getApplyState()===f.applyState.APPLY_FAILED};f.prototype.isApplyProcessFinished=function(){return this.isSuccessfullyApplied()||this.hasApplyProcessFailed()};f.prototype.hasRevertProcessStarted=function(){return this.getApplyState()===f.applyState.REVERTING};f.prototype.isRevertProcessFinished=function(){return this.getApplyState()===f.applyState.REVERT_FINISHED};f.prototype.isCurrentProcessFinished=function(){return this._aQueuedProcesses.length===0&&this.getApplyState()!==f.applyState.INITIAL};f.prototype.addChangeProcessingPromise=function(e){if(!this._oChangeProcessingPromises[e]){this._oChangeProcessingPromises[e]={};this._oChangeProcessingPromises[e].promise=new Promise(function(t){this._oChangeProcessingPromises[e].resolveFunction={resolve:t}}.bind(this))}return this._oChangeProcessingPromises[e].promise};f.prototype.addChangeProcessingPromises=function(){var e=[];if(this.getApplyState()===f.applyState.INITIAL&&this._oChangeProcessedPromise){e.push(this._oChangeProcessedPromise.promise)}this._aQueuedProcesses.forEach(function(t){e.push(this.addChangeProcessingPromise(t))},this);return e};f.prototype.addPromiseForApplyProcessing=function(){return this.addChangeProcessingPromise(f.operations.APPLY)};f.prototype._resolveChangeProcessingPromiseWithError=function(e,t){if(this._oChangeProcessingPromises[e]){this._oChangeProcessingPromises[e].resolveFunction.resolve(t);delete this._oChangeProcessingPromises[e]}if(this._oChangeProcessedPromise){this._oChangeProcessedPromise.resolveFunction.resolve(t);this._oChangeProcessedPromise=null}};f.prototype._isValidState=function(e){var t=false;Object.keys(f.states).some(function(i){if(f.states[i]===e){t=true}return t});if(!t){return false}if(this.getState()===f.states.NEW&&e===f.states.DIRTY){return false}return true};f.prototype.isVariant=function(){return this.getFileType()==="variant"};f.prototype.getChangeType=function(){return this.getDefinition().changeType};f.prototype.getFileName=function(){return this.getDefinition().fileName};f.prototype.getFileType=function(){return this.getDefinition().fileType};f.prototype.getPackage=function(){return this.getDefinition().packageName};f.prototype.setPackage=function(e){if(typeof e!=="string"){a.error("sap.ui.fl.Change.setPackage : sPackage is not defined")}this._oDefinition.packageName=e};f.prototype.getNamespace=function(){return this.getDefinition().namespace};f.prototype.setNamespace=function(e){this._oDefinition.namespace=e};f.prototype.getModuleName=function(){return this.getDefinition().moduleName};f.prototype.setModuleName=function(e){this._oDefinition.moduleName=e};f.prototype.getProjectId=function(){return this.getDefinition().projectId};f.prototype.getId=function(){return this.getDefinition().fileName};f.prototype.getContent=function(){return this.getDefinition().content};f.prototype.setContent=function(e){this._oDefinition.content=e;this.setState(f.states.DIRTY)};f.prototype.getVariantReference=function(){return this.getDefinition().variantReference||""};f.prototype.setVariantReference=function(e){this._oDefinition.variantReference=e;this.setState(f.states.DIRTY)};f.prototype.getSelector=function(){return this.getDefinition().selector};f.prototype.setSelector=function(e){this._oDefinition.selector=e};f.prototype.getText=function(e){if(typeof e!=="string"){a.error("sap.ui.fl.Change.getTexts : sTextId is not defined")}if(this.getDefinition().texts){if(this.getDefinition().texts[e]){return this.getDefinition().texts[e].value}}return""};f.prototype.getTexts=function(){if(e(this.getDefinition().texts)){return Object.assign({},this.getDefinition().texts)}return this.getDefinition().texts};f.prototype.setText=function(e,t,i){if(typeof e!=="string"){a.error("sap.ui.fl.Change.setTexts : sTextId is not defined");return}this._oDefinition.texts=this.getDefinition().texts||{};if(this._oDefinition.texts){if(this._oDefinition.texts[e]){this._oDefinition.texts[e].value=t}else{this._oDefinition.texts[e]={value:t,type:i}}this.setState(f.states.DIRTY)}};f.prototype.getODataInformation=function(){return this.getDefinition().oDataInformation};f.prototype.isChangeFromOtherSystem=function(){var e=this._oDefinition.sourceSystem;var t=this._oDefinition.sourceClient;if(!e||!t){return false}var i=s.getInstanceOrUndef();if(!i){return true}var n=i.getSystem();var o=i.getClient();if(!n||!o){return false}return e!==n||t!==o};f.prototype.markForDeletion=function(){this.setState(f.states.DELETED)};f.prototype.restorePreviousState=function(){if(this._sPreviousState){this.setState(this._sPreviousState);delete this._sPreviousState}};f.prototype.setRequest=function(e){if(typeof e!=="string"){a.error("sap.ui.fl.Change.setRequest : sRequest is not defined")}this._sRequest=e};f.prototype.getRequest=function(){return this._sRequest};f.prototype.getLayer=function(){return this.getDefinition().layer};f.prototype.getComponent=function(){return this.getDefinition().reference};f.prototype.setComponent=function(e){this._oDefinition.reference=e};f.prototype.getCreation=function(){return this.getDefinition().creation};f.prototype.setCreation=function(e){this._oDefinition.creation=e};f.prototype.isUserDependent=function(){return this._bUserDependent};f.prototype.getDefinition=function(){return this._oDefinition};f.prototype.convertToFileContent=function(){return this.getDefinition()};f.prototype.setResponse=function(e){var t=JSON.stringify(e);if(t){this._oDefinition=JSON.parse(t);this.setState(f.states.PERSISTED)}};f.prototype.addDependentControl=function(e,t,i,n){if(!e){throw new Error("Parameter vControl is mandatory")}if(!t){throw new Error("Parameter sAlias is mandatory")}if(!i){throw new Error("Parameter mPropertyBag is mandatory")}if(!this._oDefinition.dependentSelector){this._oDefinition.dependentSelector={}}if(this._oDefinition.dependentSelector[t]){throw new Error("Alias '"+t+"' already exists in the change.")}var o=i.modifier;var r=i.appComponent;if(Array.isArray(e)){var s=[];e.forEach(function(e){s.push(o.getSelector(e,r,n))});this._oDefinition.dependentSelector[t]=s}else{this._oDefinition.dependentSelector[t]=o.getSelector(e,r,n)}delete this._aDependentSelectorList};f.prototype.getDependentControl=function(e,t){var i=[];var n;if(!e){throw new Error("Parameter sAlias is mandatory")}if(!t){throw new Error("Parameter mPropertyBag is mandatory")}var o=t.modifier;var r=t.appComponent;if(!this._oDefinition.dependentSelector){return undefined}n=this._oDefinition.dependentSelector[e];if(Array.isArray(n)){n.forEach(function(e){i.push(o.bySelector(e,r,t.view))});return i}return o.bySelector(n,r,t.view)};f.prototype.getOriginalSelector=function(){return this.getDefinition().dependentSelector&&this.getDefinition().dependentSelector.originalSelector};f.prototype.getDependentSelector=function(){return this.getDefinition().dependentSelector};f.prototype.setDependentSelector=function(e){this._oDefinition.dependentSelector=e};f.prototype.getDependentSelectorList=function(){var e=this;var t=[this.getSelector()];if(!this._aDependentSelectorList){if(this.getDefinition().dependentSelector){Object.keys(this.getDefinition().dependentSelector).some(function(i){if(i==="originalSelector"){t=[this.getSelector()];return true}var n=e.getDefinition().dependentSelector[i];if(!Array.isArray(n)){n=[n]}n.forEach(function(e){if(e&&o.indexOfObject(t,e)===-1){t.push(e)}})}.bind(this))}this._aDependentSelectorList=t}return this._aDependentSelectorList};f.prototype.getDependentControlSelectorList=function(){var e=this.getDependentSelectorList().concat();if(e.length>0){var t=this.getSelector();var i=o.indexOfObject(e,t);if(i>-1){e.splice(i,1)}}return e};f.prototype.getRevertData=function(){if(e(this._vRevertData)){return Object.assign({},this._vRevertData)}return this._vRevertData};f.prototype.hasRevertData=function(){return this._vRevertData!==null};f.prototype.setRevertData=function(e){if(e===undefined){throw new Error("Change cannot be applied in XML as revert data is not available yet. Retrying in JS.")}this._vRevertData=e};f.prototype.resetRevertData=function(){this.setRevertData(null)};f.prototype.getExtensionPointInfo=function(){if(e(this._oExtensionPointInfo)){return Object.assign({},this._oExtensionPointInfo)}return this._oExtensionPointInfo};f.prototype.setExtensionPointInfo=function(e){this._oExtensionPointInfo=e};f.prototype.getSupportInformation=function(){return Object.assign({},this._oDefinition.support)};f.prototype.setSupportInformation=function(e){this._oDefinition.support=e};f.prototype.getJsOnly=function(){return this.getDefinition().jsOnly};f.prototype.setJsOnly=function(e){this._oDefinition.jsOnly=e};f.prototype.isAppDescriptorChange=function(){return this.getDefinition().appDescriptorChange};f.createInitialFileContent=function(e){if(!e){e={}}var t;if(e.fileType){t=e.fileType}else{t=e.isVariant?"variant":"change"}var s={fileName:e.id||o.createDefaultFileName(e.changeType),fileType:t,changeType:e.changeType||"",moduleName:e.moduleName||"",reference:e.reference||"",packageName:e.packageName||"",content:e.content||{},selector:e.selector||{id:""},layer:e.layer||(e.isUserDependent?n.USER:r.getCurrentLayer()),texts:e.texts||{},namespace:e.namespace||o.createNamespace(e,t),projectId:e.projectId||e.reference&&e.reference.replace(".Component","")||"",creation:"",originalLanguage:o.getCurrentLanguage()||"",support:{generator:e.generator||"Change.createInitialFileContent",service:e.service||"",user:"",sapui5Version:i.getConfiguration().getVersion().toString(),sourceChangeFileName:e.support&&e.support.sourceChangeFileName||"",compositeCommand:e.support&&e.support.compositeCommand||"",command:e.command||e.support&&e.support.command||""},oDataInformation:e.oDataInformation||{},dependentSelector:e.dependentSelector||{},jsOnly:e.jsOnly||false,variantReference:e.variantReference||"",appDescriptorChange:c(p.getChangeTypes(),e.changeType)};return s};return f},true);